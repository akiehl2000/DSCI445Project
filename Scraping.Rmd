---
title: "Scraping Script"
author: "Adam Kiehl"
date: "11/10/21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rvest)
library(XML)
```

## Variable Setup

A dictionary relating full team names to their three-letter codes. 
```{r}
teams <- data.frame(team = character(), team_code = character()) %>%
  rbind(data.frame(team = 'Kansas City Chiefs', team_code = 'kan')) %>%
  rbind(data.frame(team = 'Minnesota Vikings', team_code = 'min')) %>%
  rbind(data.frame(team = 'Los Angeles Chargers', team_code = 'sdg')) %>%
  rbind(data.frame(team = 'New England Patriots', team_code = 'nwe')) %>%
  rbind(data.frame(team = 'Cincinnati Bengals', team_code = 'cin')) %>%
  rbind(data.frame(team = 'Baltimore Ravens', team_code = 'rav')) %>%
  rbind(data.frame(team = 'Green Bay Packers', team_code = 'gnb')) %>%
  rbind(data.frame(team = 'Pittsburgh Steelers', team_code = 'pit'))
```

```{r}
names <- list()
names[['player_offense']] <- c('Player', 'Team', 'Cmp', 'PassAtt', 'PassYds', 'PassTD', 'Int', 'Sk', 'YdsLost', 'PassLng', 'Rate', 'RushAtt',
                               'RushYds', 'RushTD', 'RushLng', 'Tgt', 'Rec', 'RecYds', 'RecTD', 'RecLng', 'Fmb', 'FL')
names[['passing_advanced']] <- c()
names[['rushing_advanced']] <- c()
names[['receiving_advanced']] <- c()
```

```{r}
offense <- data.frame(matrix(ncol = length(names[['player_offense']]), nrow = 0))
names(offense) <- names[['player_offense']]

passing <- data.frame(matrix(ncol = length(names[['passing_advanced']]), nrow = 0))
names(offense) <- names[['passing_advanced']]

rushing <- data.frame(matrix(ncol = length(names[['rushing_advanced']]), nrow = 0))
names(offense) <- names[['rushing_advanced']]

receiving <- data.frame(matrix(ncol = length(names[['receiving_advanced']]), nrow = 0))
names(offense) <- names[['receiving_advanced']]
```

## Function Setup

A simple function that translates a full team name into its respective team code. 
```{r}
decode_team <- function(team) {
  teams$team_code[which(teams$team == team)]
}
```

A helper function for scrape_stats(). Given a team code and a year, this function returns the game codes of all regular season games played. 
```{r, warning=FALSE}
scrape_games <- function(team, year, master_games) {
  # Extract game log for (team, year) combination
  url <- paste('https://www.pro-football-reference.com/teams/', team, '/', year, '/gamelog/', sep = '')
  page <- read_html(url)
  
  # Extract tables and parse game log
  tbls <- page %>%
    html_nodes('table')
  for (tbl in tbls) {
    id <- html_attr(tbl, 'id')
    if (id == paste('gamelog', year, sep = '')) {
      df <- html_table(tbl) %>%
        as.data.frame()
      
      # Rename fields
      names(df) <- df[1,]
      names(df)[7] <- 'HA'
      df <- df[-1,]
      
      # Return constructed game codes
      codes <- build_game_codes(df$Date, df$HA, df$Opp, team, year)
      codes <- codes[!(codes %in% master_games)]
      return(codes)
    }
  }
}
```

A helper function for scrape_games(). This function takes scraped date and opponent data from a team's game log and constructs game codes according to PFR's naming system. The format is yyyymmdd0{home team code}. 
```{r}
build_game_codes <- function(dates, HAs, opps, team, year) {
  # Format as date and remove default year
  codes <- dates %>%
    as.Date(format = '%B%d') %>%
    as.character()  %>%
    substr(6, 10)  %>%
    str_replace('-', '')

  # Loop through games
  for (i in 1:length(codes)) {
    # Determine whether year or year+1 should be used for the game code and append
    if (as.numeric(substr(codes[i], 1, 2)) < 6) {
      codes[i] <- paste(as.character(as.numeric(year) + 1), codes[i], '0', sep = '')
    }
    else{
      codes[i] <- paste(year, codes[i], '0', sep = '')
    }
    
    # Determine home team and append
    if (HAs[i] == '@') {
      codes[i] <- paste(codes[i], decode_team(opps[i]), sep = '')
    }
    else {
      codes[i] <- paste(codes[i], team, sep = '')
    }
  }
  
  # Return constructed game codes
  return(codes)
}
```

Given a team code and year, this function accesses the game log and subsequent box scores of every unexplored game played that regular season. The tables of interest in each game page are `player_offense`, `passing_advanced`, `rushing_advanced`, and `receiving_advanced`. 
```{r}
scrape_table <- function(game_code, table, names) {
  # Construct URL and extract tables into list
  url <- paste('https://www.pro-football-reference.com/boxscores/', game_code, '.htm', sep = '')
  tbls <- read_html(url) %>% 
    gsub(pattern='<!--', replacement='') %>% 
    gsub(pattern='-->', replacement='') %>%
    readHTMLTable()
  
  # Extract table of interst into local data frame
  temp <- data.frame(tbls[[table]])
  
  # Rename and tag data frame
  names(temp) <- names[[table]]
  temp <- temp %>%
    mutate(Game = game_code) %>%
    filter(Player != '', Player != 'Player')
  
  return(temp)
}
```


```{r}
scrape_stats <- function(names, table) {
  # Use master game codes list to track already-explored games
  master_games <- c()
  # Build temporary data frame to fill
  temp <- data.frame(matrix(ncol = length(names[[table]]), nrow = 0))
  names(temp) <- names[[table]]
  
  # Loop through years
  for (year in '2021') {
    # Loop through teams
    for (team in 'cle') {
      # Retrieve unexplored game codes for (year, team) combinations using helper functions
      game_codes <- scrape_games(team, year, master_games)
      
      # Loop through game codes
      for (game_code in game_codes[1:5]) {
        
        temp <- rbind(temp, scrape_table(game_code, table, names))
      }
    }
  }
  
  return(temp)
}
```

## Scraping Body

```{r}
offense <- scrape_stats(names, 'player_offense')
passing <- scrape_stats(names, 'passing_advanced')
rushing <- scrape_stats(names, 'rushing_advanced')
receiving <- scrape_stats(names, 'receiving_advanced')
```


TODO:
- Determine scope of scraping
- Finish constructing team map
- Construct year, team loop


